<!doctype html>
<html lang="en">

<head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta content="width=device-width, initial-scale=1" name="viewport" />

    <!-- update the version number as needed -->
    <script defer src="/__/firebase/10.14.1/firebase-app-compat.js"></script>
    <!-- include only the Firebase features as you need -->
    <script defer src="/__/firebase/10.14.1/firebase-auth-compat.js"></script>
    <script defer src="/__/firebase/10.14.1/firebase-database-compat.js"></script>

    <script defer src="/__/firebase/init.js?useEmulator=true"></script>
    <link id="pageStyles" rel="stylesheet" href="/todo.css" />

</head>

<body>
    <div id="toDo-page">
        <div id="headerArea">
            <header id="title">To Do List:</header>

            <button id="logOut">Log Out</button>
        </div>

        <form id="inputForm">
            <div id="newEntryBox">
                <input id="inputBox" type="textarea" name="name" placeholder="New Entry Here">
                <input id="addTask" type="submit" value="✓">
            </div>
            <ul id="listBox">
                <div id="taskBoxTest" class="taskBox">
                    <div id="taskText" class="taskText">
                    </div>
                    <div class="buttonDiv">
                        <Button id="editButton" class="editButton">✎</Button>
                        <Button id="deleteButton" class="deleteButton">X</Button>
                    </div>
                </div>
            </ul>
        </form>

    </div>
    <script type="module">
        // Import the functions you need from the SDKs you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js";
        //import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-analytics.js";
        const firebaseConfig = {
            apiKey: "AIzaSyDR-KgyPWiGSM7kz2dioVVWlFZO1g35SvE",
            authDomain: "cpeg470-proj1-2b1ec.firebaseapp.com",
            databaseURL: "https://cpeg470-proj1-2b1ec-default-rtdb.firebaseio.com",
            projectId: "cpeg470-proj1-2b1ec",
            storageBucket: "cpeg470-proj1-2b1ec.appspot.com",
            messagingSenderId: "900830850408",
            appId: "1:900830850408:web:f47604d97db5457b5c3add",
            measurementId: "G-N41B7W2X03"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        import { getDatabase, ref, set, onValue, child, get, push, update, remove } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-database.js';

        //const analytics = getAnalytics(app);
        const db = getDatabase(app);

        let inputBox = document.getElementById("inputBox");
        let addTask = document.getElementById("addTask");
        let listBox = document.getElementById("listBox");
        let editButton = document.getElementById("editButton");
        let deleteButton = document.getElementById("deleteButton");
        let logOut = document.getElementById("logOut");
        const userId = localStorage.getItem("userId");
        console.log("userId " + userId);

        if (!userId) {
            window.location.href = "index.html";
        } else {
            const todoRef = ref(db, "users/" + userId + "/todo");

            onValue(todoRef, (snapshot) => {
                const tasks = snapshot.val();
                // Handle the tasks data as needed
            }, (error) => {
                console.error("Error reading from Firebase: ", error);
            });
        }

        function LogOut(){
            localStorage.removeItem("userId");
            window.location.href = 'index.html';
        }


        function setupTaskListener() {
            const inputForm = document.getElementById("inputForm"); // Assuming this is your form ID
            inputForm.addEventListener("submit", function (event) {
                event.preventDefault(); // Prevent the form from submitting normally
                AddTask(); // Call the function to add the task
            });
        }

        function AddTask() {
            const newTask = inputBox.value.trim(); // Get the value from the input box

            if (newTask) {
                const todoRef = ref(db, "users/" + userId + "/todo");

                // Make a new unique key
                const newTaskRef = push(todoRef);

                //set the new task under the unique key
                set(newTaskRef, newTask).then(() => {
                    console.log("Task added successfully!");
                    inputBox.value = ""; // Clear input box
                }).catch((error) => {
                    console.error("Error adding task: ", error);
                });
            } else {
                console.log("Need to add a task");
            }

        }


        function loadTasks() {
            const todoRef = ref(db, "users/" + userId + "/todo");

            // Using onValue to listen for changes
            onValue(todoRef, (snapshot) => {
                const tasks = snapshot.val(); // Get the current value of 'todo'
                listBox.innerHTML = '';
                if (tasks) {
                    console.log("Current tasks: ", tasks);
                    // Iterate through each task
                    for (const key in tasks) {
                        if (tasks.hasOwnProperty(key)) {
                            const task = tasks[key]; // Access the task value
                            //console.log(`Task ID: ${key}, Task: ${task}`); 
                            createTaskDiv(key, task);
                        }
                    }
                } else {
                    console.log("No tasks found.");
                }
            });
        }

        /* creates divs for each of the tasks*/
        function createTaskDiv(taskId, taskText) {
            const listBox = document.getElementById("listBox");

            const taskBox = document.createElement("div");
            taskBox.classList.add("taskBox");

            const taskTextDiv = document.createElement("div");
            taskTextDiv.classList.add("taskText");
            taskTextDiv.innerText = taskText;

            const buttonDiv = document.createElement("div");
            buttonDiv.classList.add("buttonDiv");

            const editButton = document.createElement("button");
            editButton.classList.add("editButton");
            editButton.innerText = "✎";
            editButton.addEventListener("click", () => EditTask(taskId, taskText));

            const deleteButton = document.createElement("button");
            deleteButton.classList.add("deleteButton");
            deleteButton.innerText = "X";
            deleteButton.addEventListener("click", () => DeleteTask(taskId));

            buttonDiv.appendChild(editButton);
            buttonDiv.appendChild(deleteButton);
            taskBox.appendChild(taskTextDiv);
            taskBox.appendChild(buttonDiv);
            listBox.appendChild(taskBox);
            console.log(taskId);
        }

        function EditTask(taskId, currentTask) {
            const newText = prompt("Edit task:", currentTask); // ask for text
            if (newText !== null) {
                if (newText.trim()) {
                    const taskRef = ref(db, "users/" + userId + "/todo/" + taskId);
                    set(taskRef, newText) //Change to new input
                        .then(() => {
                            console.log("Task updated successfully!");
                        })
                        .catch((error) => {
                            console.error("Error updating task: ", error);
                        });
                } else {
                    console.log("Task cannot be empty.");
                }
            }
        }

        function DeleteTask(taskId) {
            console.log(taskId);
            const taskRef = ref(db, "users/" + userId + "/todo/" + taskId);
            remove(taskRef)
                .then(() => {
                    console.log("Task deleted successfully!");
                })
                .catch((error) => {
                    console.error("Error deleting task: ", error);
                    alert("Failed to delete task. Please try again.");

                });
        }

        function startPage() {
            setupTaskListener();
            loadTasks();
        }
        document.addEventListener("DOMContentLoaded", startPage);
        logOut.addEventListener('click', LogOut);
    </script>
</body>